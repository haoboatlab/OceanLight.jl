<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Implement MPI · OceanLight.jl</title><meta name="title" content="Implement MPI · OceanLight.jl"/><meta property="og:title" content="Implement MPI · OceanLight.jl"/><meta property="twitter:title" content="Implement MPI · OceanLight.jl"/><meta name="description" content="Documentation for OceanLight.jl."/><meta property="og:description" content="Documentation for OceanLight.jl."/><meta property="twitter:description" content="Documentation for OceanLight.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">OceanLight.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Quick Start</span><ul><li><a class="tocitem" href="../Center/">Photons at the center</a></li><li class="is-active"><a class="tocitem" href>Implement MPI</a><ul class="internal"><li><a class="tocitem" href="#Problem"><span>Problem</span></a></li><li><a class="tocitem" href="#Initialize-MPI-and-variables"><span>Initialize MPI and variables</span></a></li><li><a class="tocitem" href="#Monte-Carlo-path-with-MPI"><span>Monte Carlo path with MPI</span></a></li><li class="toplevel"><a class="tocitem" href="#Run-.jl-file"><span>Run .jl file</span></a></li><li class="toplevel"><a class="tocitem" href="#Visualization"><span>Visualization</span></a></li><li><a class="tocitem" href="#Reference"><span>Reference</span></a></li></ul></li></ul></li><li><span class="tocitem">Module</span><ul><li><a class="tocitem" href="../../module/Parameters/">Parameters</a></li><li><a class="tocitem" href="../../module/refraction/">Refraction</a></li><li><a class="tocitem" href="../../module/MonteCarlo/">Monte Carlo Simulation</a></li></ul></li><li><span class="tocitem">Simulation</span><ul><li><a class="tocitem" href="../../Simulation/ModelSetup/">Model Setup</a></li><li><a class="tocitem" href="../../Simulation/AirWaveInteract/">Air-Water Interaction</a></li><li><a class="tocitem" href="../../Simulation/WithinWater/">Light within Water</a></li><li><a class="tocitem" href="../../Simulation/Exporting/">Exporting data</a></li></ul></li><li><a class="tocitem" href="../../contribute/">Contributor&#39;s guide</a></li><li><a class="tocitem" href="../../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Quick Start</a></li><li class="is-active"><a href>Implement MPI</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Implement MPI</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/tayT0T/OceanLight.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/tayT0T/OceanLight.jl/blob/main/docs/src/QuickStart/MPI.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Implementing-MPI"><a class="docs-heading-anchor" href="#Implementing-MPI">Implementing MPI</a><a id="Implementing-MPI-1"></a><a class="docs-heading-anchor-permalink" href="#Implementing-MPI" title="Permalink"></a></h1><p>Since <code>OceanLight.jl</code> implements the Monte Carlo ray tracing algorithm, the accuracy of the solution depends on its convergence. However, this can be inefficient and time-consuming for specific problems that require a large number of photons <code>nphoton</code>. To address this issue, rather than running the entire simulation on a single CPU, we can allocate smaller chunks of photons across multiple CPUs, simulate them independently, and later combine the results into a single solution. That’s where MPI comes in.</p><p>MPI, or Message Passing Interface, is a communication library designed for sending and receiving messages across multiple processors, making it suitable for parallel programming. To install MPI on your system, check out the <a href="https://docs.open-mpi.org/en/v5.0.x/installing-open-mpi/quickstart.html">Installing Open MPI guide</a></p><h2 id="Problem"><a class="docs-heading-anchor" href="#Problem">Problem</a><a id="Problem-1"></a><a class="docs-heading-anchor-permalink" href="#Problem" title="Permalink"></a></h2><p>In this example, the problem is to calculate the downwelling irradiance field when the surface is completely flat, and a total of 10,000,000 photons are focused at a single point in the center. Our domain of interest is defined as <span>$x,y \in \left[\mathrm{-10m},\mathrm{10m}\right]$</span>, and <span>$z \in \left[\mathrm{-190m},\mathrm{10m}\right]$</span> in depth, corresponding to a grid resolution of <span>$512 \times 512 \times 200$</span> points. Periodic boundary conditions are applied at the domain boundaries. The attenuation properties of water are characterized by an absorption coefficient of <span>$a = 0.0196$</span> and a scattering coefficient of <span>$b = 0.0031$</span>, which correspond to the optical properties of seawater at a wavelength of <span>$490 ,\mathrm{nm}$</span> <sup class="footnote-reference"><a id="citeref-1" href="#footnote-1">[1]</a></sup>.</p><p>To execute parallel programming using MPI, our Julia program must be run through a <code>.jl</code> script file. Inside the script file, we first create input data structures for the simulation. Here, <code>OceanLight.writeparams</code> will create a new input file in <code>.yml</code> format.</p><pre><code class="language-julia hljs">using OceanLight
using Random</code></pre><pre><code class="language-julia hljs"># irradiance
nz = 200; dz = 1; nxe = 512; nye = 512; num = 31; ztop = 10
# photon
nphoton = 10000000; kr = 10; nxp = 512; kbc = 0; b = 0.0031; nyp = 512; a = 0.0196;
# wave
pey = 2*pi/20.0; nxeta = 512; nyeta = 512; pex = 2*pi/20.0;

data=Dict(&quot;irradiance&quot;=&gt;Dict(&quot;nxe&quot;=&gt;nxe,&quot;nye&quot;=&gt;nye,&quot;nz&quot;=&gt;nz,&quot;dz&quot;=&gt;dz,&quot;ztop&quot;=&gt;ztop,&quot;num&quot;=&gt;num),
            &quot;wave&quot;=&gt;Dict(&quot;pex&quot;=&gt;pex,&quot;pey&quot;=&gt;pey,&quot;nxeta&quot;=&gt;nxeta,&quot;nyeta&quot;=&gt;nyeta),
            &quot;photon&quot;=&gt;Dict(&quot;nxp&quot;=&gt;nxp,&quot;nyp&quot;=&gt;nyp,&quot;nphoton&quot;=&gt;nphoton,&quot;a&quot;=&gt;a,&quot;b&quot;=&gt;b,&quot;kr&quot;=&gt;kr,&quot;kbc&quot;=&gt;kbc))

OceanLight.writeparams(data)</code></pre><p>For a step-by-step description and the utility of each function, check out this <a href="https://haoboatlab.github.io/OceanLight.jl/dev/QuickStart/Center/">tutorial</a>. </p><h2 id="Initialize-MPI-and-variables"><a class="docs-heading-anchor" href="#Initialize-MPI-and-variables">Initialize MPI and variables</a><a id="Initialize-MPI-and-variables-1"></a><a class="docs-heading-anchor-permalink" href="#Initialize-MPI-and-variables" title="Permalink"></a></h2><p>To enable parallel programming in Julia, we first import the <code>MPI</code> package and then initialize the environment with <code>MPI.Init()</code>.  </p><pre><code class="language-julia hljs">using MPI
MPI.Init()</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">MPI.ThreadLevel(2)</code></pre><p>First, <code>MPI.COMM_WORLD</code> is a predefined intracommunicator that represents the group of processes launched with MPI. We will declare it as the variable <code>comm</code>. Each processor inside the communicator has a unique rank, or ID number, which we can access through <code>MPI.Comm_rank(comm)</code>. Lastly, we can obtain the number of processors inside the communicator with <code>MPI.Comm_size(comm)</code>. </p><pre><code class="language-julia hljs">comm = MPI.COMM_WORLD
processor_id = MPI.Comm_rank(comm)
number_cpu = MPI.Comm_size(comm)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1</code></pre><p>Users need to specify these variables and their corresponding dimensions.</p><p><strong>NOTE:</strong> The random number generator is created with <code>MersenneTwister</code>. Given the same input or seed, this pseudorandom number generator (PRNG) will always produce random numbers in a predictable and reproducible way. Hence, to ensure the independence of Monte Carlo paths across all processors, we need to offset the seed in each processor so that it does not generate the exact same random numbers.<code>ix</code> and <code>iy</code> are the array coordination corresponding to the center of the field.  </p><pre><code class="language-julia hljs">p = OceanLight.readparams()

η = zeros(p.nxs,p.nys)
ηx = zeros(p.nxs,p.nys)
ηy = zeros(p.nxs,p.nys)
randrng = MersenneTwister(1234 + processor_id)
ϕps,θps = phasePetzold()
ed = zeros(p.nx,p.ny,p.nz)
esol = zeros(p.num,p.nz)
area = zeros(4)
interi = zeros(Int64,4)
interj = zeros(Int64,4)
ix = div(p.nxη,2) + 1
iy = div(p.nyη,2) + 1</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">257</code></pre><h2 id="Monte-Carlo-path-with-MPI"><a class="docs-heading-anchor" href="#Monte-Carlo-path-with-MPI">Monte Carlo path with MPI</a><a id="Monte-Carlo-path-with-MPI-1"></a><a class="docs-heading-anchor-permalink" href="#Monte-Carlo-path-with-MPI" title="Permalink"></a></h2><p>The general idea of implementing parallel programming in <code>OceanLight.jl</code> is that multiple CPUs can work simultaneously to obtain results. First, we define a range of Photon IDs <code>photon_list</code>, which is a sequence of positive integers representing the total number of photons to be simulated. From this range, we distribute an equal number of photons to each processor, stored as <code>cpu_number_photon</code>. Once the refraction at the interface is calculated, all photons proceed to follow independent Monte Carlo paths. We then loop through every individual photon on each processor, specifying its starting point <code>starting</code> and ending point <code>ending</code> for the <code>for</code> loop. Finally, once all simulations are complete, we combine the results across all processors. </p><pre><code class="language-julia hljs">photon_list = 1:p.nphoton
total_number_photon = p.nphoton

if mod(total_number_photon,number_cpu) ==0
    cpu_number_photon = div(total_number_photon , number_cpu)
else
    cpu_number_photon = div(total_number_photon , number_cpu) + 1
end

starting = (processor_id * cpu_number_photon) + 1
ending = (processor_id + 1) * cpu_number_photon

if ending &gt; total_number_photon
    ending = total_number_photon
end

MPI.Allreduce!(η,+,comm)
MPI.Allreduce!(ηx,+,comm)
MPI.Allreduce!(ηy,+,comm)
if p.z[1] &lt;= maximum(η)
    error(&quot;ztop smaller than maximum η!&quot;)
end
println(&quot;Processor ID $processor_id wave surface input complete!&quot;)
xpb,ypb,zpb,θ,ϕ,fres = interface(η,ηx,ηy,p)
println(&quot;Processor ID $processor_id refraction at interface complete!&quot;)

for ind = starting:ending
    ip = photon_list[ind]
    OceanLight.transfer!(ed,esol,θ[ix,iy],ϕ[ix,iy],fres[ix,iy],ip,
                xpb[ix,iy],ypb[ix,iy],zpb[ix,iy],area,interi,interj,
                                    randrng,η,ϕps,θps,p,1)
end

MPI.Allreduce!(ed,+,comm)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">513×513×200 Array{Float64, 3}:
[:, :, 1] =
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 ⋮                        ⋮              ⋱                      ⋮         
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0

[:, :, 2] =
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 ⋮                        ⋮              ⋱                      ⋮         
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0

[:, :, 3] =
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 ⋮                        ⋮              ⋱                      ⋮         
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0

;;; … 

[:, :, 198] =
 0.0        0.0        0.0        …  0.0        0.0        0.0
 0.0        0.0        0.0           0.0        0.0        0.0
 0.0        0.0        0.0           0.0        0.0        0.0
 0.0        0.0        0.0           0.478597   0.0        0.0
 0.0        0.0        0.0           0.242808   0.356265   0.0
 0.0        0.0        0.0        …  0.096168   0.243489   0.0
 0.0        0.0        0.0           0.13734    0.102903   0.0
 0.0        0.0        0.514247      0.177975   0.133349   0.0
 0.0        0.0        0.158979      0.0        0.0        0.0
 0.315953   1.07201    0.0           0.0        0.0        0.0
 ⋮                                ⋱  ⋮                     
 0.0817583  0.0484446  0.0           0.0        0.0        0.0
 0.326991   0.193753   0.0        …  0.0849079  0.151829   0.0
 0.0        0.169935   0.0193154     0.212081   0.379236   0.0
 0.0        0.69873    0.0794201     0.0        0.0        0.0
 0.0        0.0        0.299683      0.0        0.94319    0.221121
 0.0        0.0        0.603661      0.896402   1.1644     0.347432
 0.0        0.0        0.0        …  0.116299   0.0838547  0.0
 0.0        0.0        0.0377761     0.0        0.0        0.0
 0.0        0.0        0.305436      0.0        0.0        0.0

[:, :, 199] =
 0.0        0.0        0.0       …  0.0        0.0         0.0
 0.010297   0.0148493  0.0          0.0        0.0         0.0
 0.396524   0.571827   0.0          0.0        0.0         0.0
 0.0648404  0.0867042  0.822584     0.0        0.0547091   0.228477
 0.773911   0.144644   0.641041     0.0        0.13323     0.556395
 0.0        0.0        0.0       …  0.499228   0.163776    0.0
 0.0        0.0        0.0          0.170525   0.055942    0.0
 0.0        0.0        0.28437      0.0        0.0         0.0
 0.0375877  0.108528   0.46356      0.365431   0.4858      0.0291493
 0.456382   1.25321    0.224115     0.132333   0.242963    0.0268254
 ⋮                               ⋱  ⋮                      
 0.0        0.0        0.0          0.468545   0.0         0.0
 0.0        0.0        0.0       …  0.0453452  0.0         0.0
 0.0        0.0        0.0          0.0        0.0         0.0
 0.0        0.0        0.0          0.0        0.0         0.0
 0.0        0.0        0.0          0.0        0.0         0.0
 0.0        0.0        0.0          0.0650079  0.0         0.0
 0.0250784  0.0067005  0.0       …  1.52237    0.0221846   0.0
 0.760211   0.203115   0.0          0.160624   0.00440065  0.0
 0.0        0.0        0.0          0.0        0.0         0.0

[:, :, 200] =
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 ⋮                        ⋮              ⋱                      ⋮         
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  …  0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0     0.0  0.0  0.0  0.0  0.0  0.0  0.0</code></pre><p>Since the simulation is running from a Julia script file, we apply periodic boundary conditions and export the results in <code>.h5</code> format for later accesability. </p><pre><code class="nohighlight hljs">if processor_id == 0
    OceanLight.applybc!(ed,p)
    OceanLight.exported(ed,η,p,&quot;rawdat/case$(icase)/ed&quot;,&quot;3D&quot;,176)
end</code></pre><p>Once <code>MPI</code> finishes its task, we end the communication process with <code>MPI.Finalize</code>. </p><pre><code class="language-julia hljs">MPI.Barrier(comm)
MPI.Finalize()</code></pre><h1 id="Run-.jl-file"><a class="docs-heading-anchor" href="#Run-.jl-file">Run .jl file</a><a id="Run-.jl-file-1"></a><a class="docs-heading-anchor-permalink" href="#Run-.jl-file" title="Permalink"></a></h1><p>Once the Julia script file is saved, the code is ready to be executed. Within the same folder, use the command line to run <code>mpirun</code> and execute the MPI task. Here, the number following <code>-np</code> icorresponds to the number of CPUs you want to use, and do not forget to replace <code>FILE_NAME.jl</code> with the name of your Julia script file.</p><pre><code class="nohighlight hljs">mpirun -np 4 julia FILE_NAME.jl</code></pre><h1 id="Visualization"><a class="docs-heading-anchor" href="#Visualization">Visualization</a><a id="Visualization-1"></a><a class="docs-heading-anchor-permalink" href="#Visualization" title="Permalink"></a></h1><p>To visualize the downwelling irradiance field, we first extract the data from the <code>ed.h5</code> file along with the spatial coordinates in the x, y, and z directions into the <code>struct p</code>. The code example below can be directly pasted into the Julia terminal, run through a <code>.jl</code> script file, or executed in an IJulia notebook.</p><pre><code class="nohighlight hljs">using OceanLight 
using HDF5

p = OceanLight.readparams()
ed = h5open(&quot;ed.h5&quot; ,&quot;r&quot;)
ed = read(ed,&quot;ed&quot;)</code></pre><p>The visualization process is similar to the example shown <a href="https://haoboatlab.github.io/OceanLight.jl/dev/QuickStart/Center/">here</a>. </p><pre><code class="language-julia hljs">using Plots
using Plots.Measures

max_val, max_loc = findmax(ed)
ed = ed./max_val
nonzero_vals = ed[ed .!= 0]
min_val = minimum(nonzero_vals)

for i in 1:Int(nxe+1)
    for j in 1:Int(nye+1)
        for k in ztop:nz
            if ed[i,j,k] == 0
                ed[i,j,k] = min_val
            end
        end
    end
end

# Choose slice indices
iy_c = 256   # y-index for vertical cross-section
iz_a = 40    # z-index for panel (a)
iz_b = 160   # z-index for panel (b)

# Define layout: 2 rows, 2 columns, but right column spans both rows
l = @layout [grid(2,1) c]

# Panel (a) : z = iz_a
p1 = heatmap(
    p.x .-10, p.y .-10, log.(ed[:,:,iz_a]),
    clim=(-20,-7), framestyle=:box, grid=false,
    c=cgrad(:viridis), legend=:none,
    xlabel=&quot;\$x(m)\$&quot;, ylabel=&quot;\$y(m)\$&quot;,
    title=&quot;(a) z = $(round(p.z[iz_a], digits=1)) m&quot;,
    xlim=[minimum(p.x).-10, maximum(p.x).-10],
    ylim=[minimum(p.y).-10, maximum(p.y).-10])
plot!(p1, [minimum(p.x).-10, maximum(p.x).-10], [p.y[iy_c]-10, p.y[iy_c]-10],
      color=:red, lw=2, ls=:dash, alpha=0.6)

# Panel (b) : z = iz_b
p2 = heatmap(
    p.x .-10, p.y .-10, log.(ed[:,:,iz_b]),
    clim=(-20,-7), framestyle=:box, grid=false,
    c=cgrad(:viridis), legend=:none,
    xlabel=&quot;\$x(m)\$&quot;, ylabel=&quot;\$y(m)\$&quot;,
    title=&quot;(b) z = $(round(p.z[iz_b], digits=1)) m&quot;,
    xlim=[minimum(p.x).-10, maximum(p.x).-10],
    ylim=[minimum(p.y).-10, maximum(p.y).-10])
plot!(p2, [minimum(p.x).-10, maximum(p.x).-10], [p.y[iy_c]-10, p.y[iy_c]-10],
      color=:red, lw=2, ls=:dash, alpha=0.6)

# Panel (c) : vertical cross-section at y = iy_c
p3 = heatmap(
    p.x .-10, reverse(p.z), reverse(transpose(log.(ed[:,iy_c,:]))),
    clim=(-20,-7), framestyle=:box, grid=false,
    c=cgrad(:viridis), ylim=(-(nz*dz-10),0),
    xlabel=&quot;\$x(m)\$&quot;, ylabel=&quot;\$z(m)\$&quot;,
    cbar_title=&quot;\$\\ln\\frac{I(x,y,z)}{I_{0}}\$&quot;,
    title=&quot;(c) y = $(round(p.y[iy_c]-10, digits=1)) m&quot;,
    xlim=[minimum(p.x).-10, maximum(p.x).-10])

# Add horizontal lines for z = iz_a, iz_b
plot!(p3, [minimum(p.x).-10, maximum(p.x).-10], [p.z[iz_a], p.z[iz_a]],
      color=:red, lw=1.5, ls=:dash, label=&quot;&quot;, alpha=0.6)
plot!(p3, [minimum(p.x).-10, maximum(p.x).-10], [p.z[iz_b], p.z[iz_b]],
      color=:red, lw=1.5, ls=:dash, label=&quot;&quot;, alpha=0.6)

# Combine
plot(p1, p2, p3, layout=l,
     size=(900,700),
     titleloc=:left, titlefont=font(8),
     left_margin=10mm, right_margin=10mm)</code></pre><img src="5e3af6a1.svg" alt="Example block output"/><h2 id="Reference"><a class="docs-heading-anchor" href="#Reference">Reference</a><a id="Reference-1"></a><a class="docs-heading-anchor-permalink" href="#Reference" title="Permalink"></a></h2><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-1"><a class="tag is-link" href="#citeref-1">1</a>Smith, R. C., &amp; Baker, K. S. (1981). Optical properties of the clearest natural waters (200-800 nm). Applied optics, 20(2), 177–184. https://doi.org/10.1364/AO.20.000177 </li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Center/">« Photons at the center</a><a class="docs-footer-nextpage" href="../../module/Parameters/">Parameters »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Monday 29 September 2025 11:18">Monday 29 September 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
